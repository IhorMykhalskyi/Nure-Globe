function dijkstra(n,t){var r,i,u;for(r in points)points[r].mark=Number.MAX_VALUE,points[r].const=!1,points[r].from=null;for(points[n].mark=0,points[n].const=!0,i=points[n];i.key!=t;)i=dijkstra_step(i),i||console.log("граф не связен"),i.const=!0;for(i=points[t],u=[i];i.from;)i=i.from,u.push(i);return tune(u)}function dijkstra_step(n){var r,i,t,u;for(i in n.E)(t=points[i],t.const)||(d=n.E[i],n.mark+d<t.mark&&(t.mark=n.mark+d,t.from=n));r=Number.MAX_VALUE;for(i in points)(t=points[i],t.const)||t.mark<r&&(u=t,r=t.mark);return u}function tune(n){var f,i;if(n.length<4)return n;for(f=[n[0]],i=1;i<n.length-1;i++){var r=n[i-1],t=n[i],u=n[i+1],e=r.x==t.x&&t.x==u.x&&r.y==t.y&&t.y==u.y||r.x==t.x&&t.x==u.x&&r.z==t.z&&t.z==u.z||r.z==t.z&&t.z==u.z&&r.y==t.y&&t.y==u.y;e||f.push(t)}return f.push(n[n.length-1]),f}function Point(n,t,i,r){this.key=n;this.x=t;this.y=i;this.z=r;this.E={}}function init_data(n,t){var e,s,u,h,f,o,i,r;points={};for(e in n)for(f=e.split(","),u=0;u<f.length;++u)s=f[u],points[s]=new Point(s,n[e][0],n[e][1],n[e][2]);for(u=0;u<t.length;u++)for(h=t[u].replace(/,/g," "),f=h.split(" "),o=1;o<f.length;o++)if(i=f[o-1],r=f[o],points[i]&&points[r]){var c=points[i].x-points[r].x,l=points[i].y-points[r].y,a=points[i].z-points[r].z,v=Math.sqrt(c*c+l*l+a*a);points[i].E[r]=points[r].E[i]=v}else points[i]||console.log("Wrong key: "+i),points[r]||console.log("Wrong key: "+r)}function find_and_show_track(){var n=$("#from").val(),t=$("#to").val();$("#from").css("color",points[n]?"black":"red");$("#to").css("color",points[t]?"black":"red");points[n]&&points[t]?(track=dijkstra(n,t),track=track.reverse(),auto_scale(),set_current_point(track[0])):(track=null,location.replace("#dialog"))}function step_forward(){if(track!=undefined){var n=track.indexOf(current_point),t=(n+1)%track.length;set_current_point(track[n]);track[n].z==track[t].z?step_anime(track[n],track[t]):ladder_anime(track[n],track[t])}}function step_back(){if(track!=undefined){var n=(track.indexOf(current_point)-1+track.length)%track.length;set_current_point(track[n])}}function set_current_point(n){current_point=n;man.x=n.x;man.y=n.y;draw()}function draw(){var i,t,n;if(ctx.clearRect(0,0,canvas.width,canvas.height),ctx.save(),ctx.translate(shift_x,shift_y),ctx.scale(scale,scale),i=current_point.z,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(img[i],0,0),track){ctx.strokeStyle="#FF0000";ctx.lineWidth=2;ctx.beginPath();var n=track[0],r=n.x,u=n.y;for(ctx.moveTo(r,u),t=1;t<track.length;t++)n=track[t],ctx.lineTo(n.x,n.y),r=n.x,u=n.y;ctx.stroke();ctx.drawImage(man.img[man.i],man.x,man.y,8,20);man.i=(man.i+1)%2}ctx.restore();ctx.fillStyle="rgba(0, 0, 0, 0.25)";ctx.font="72px arial";ctx.fillText(current_point.z+" этаж",50,canvas.height-50)}function auto_scale(){var n=track[0];scale=2;shift_x=-n.x*scale+screen.width/2;shift_y=-n.y*scale+screen.height/2}function auto_shift(){man.x<-shift_x/scale&&(shift_x=(-man.x+10)*scale);man.x>(-shift_x+canvas.width)/scale&&(shift_x=canvas.width-(man.x+man.img[0].width+10)*scale);man.y<-shift_y/scale&&(shift_y=(-man.y+10)*scale);man.y>(-shift_y+canvas.height)/scale&&(shift_y=canvas.height-(man.y+man.img[0].height+10)*scale)}function shift_anime(n,t){var r=15,i=0,u=setInterval(function(){shift_x+=n;shift_y+=t;draw();i++;i>=r&&clearInterval(u)},20)}function scale_anime(n){var i=15,t=0,r=setInterval(function(){scale*=n;shift_x=shift_x*n-canvas.width/2*(n-1);shift_y=shift_y*n-canvas.height/2*(n-1);draw();t++;t>=i&&clearInterval(r)},20)}function step_anime(n,t){var i=10,u=(t.x-n.x)/i,f=(t.y-n.y)/i,r=0,e=setInterval(function(){man.x+=u;man.y+=f;auto_shift();draw();r++;r>=i&&(clearInterval(e),set_current_point(t),man.i=0,draw())},50)}function ladder_anime(n,t){var e=n.key[2],i,r;switch(e){case"1":i=0;r=2;break;case"2":i=2;r=0;break;case"3":i=-2;r=0}var f=20,u=0,o=setInterval(function(){u<f/2?(man.x+=i,man.y+=r):(man.x-=i,man.y-=r);draw();u++;u>=f&&(clearInterval(o),set_current_point(t))},20)}var dots,lines;(function(){var n=$.support.touch,i=n?"touchstart":"mousedown",r=n?"touchend":"mouseup",t=n?"touchmove":"mousemove";$.event.special.swipeupdown={setup:function(){var u=this,n=$(u);n.bind(i,function(i){function o(n){if(u){var t=n.originalEvent.touches?n.originalEvent.touches[0]:n;f={time:(new Date).getTime(),coords:[t.pageX,t.pageY]};Math.abs(u.coords[1]-f.coords[1])>10&&n.preventDefault()}}var e=i.originalEvent.touches?i.originalEvent.touches[0]:i,u={time:(new Date).getTime(),coords:[e.pageX,e.pageY],origin:$(i.target)},f;n.bind(t,o).one(r,function(){n.unbind(t,o);u&&f&&f.time-u.time<1e3&&Math.abs(u.coords[1]-f.coords[1])>30&&Math.abs(u.coords[0]-f.coords[0])<75&&u.origin.trigger("swipeupdown").trigger(u.coords[1]>f.coords[1]?"swipeup":"swipedown");u=f=undefined})})}};$.each({swipedown:"swipeupdown",swipeup:"swipeupdown"},function(n,t){$.event.special[n]={setup:function(){$(this).bind(t,$.noop)}}})})();dots={"116":[414,294,1],"117":[391,294,1],"118":[373,294,1],"120":[331,294,1],"123":[311,224,1],"127":[311,148,1],"128":[311,124,1],"133":[311,219,1],"134":[311,234,1],"137":[152,294,1],"139":[128,244,1],"142":[128,137,1],"144":[103,137,1],"145":[128,150,1],"146":[128,169,1],"148":[128,197,1],"151":[104,294,1],"141а":[128,156,1],"141,147":[128,184,1],L12:[128,205,1],"140а":[128,217,1],"140,149":[128,229,1],"138,150":[128,262,1],L13:[128,276,1],X11:[128,294,1],"136,165":[166,294,1],"136а":[184,294,1],X12:[249,294,1],X13:[311,294,1],"119,X14":[356,294,1],"116а":[433,294,1],"113,114":[458,294,1],L11:[249,253,1],"ВХОД":[249,339,1],"129,130,130а":[311,116,1],"128б,131":[311,132,1],"128а":[311,142,1],"126,L14":[311,156,1],"125а,М11":[311,169,1],"131а":[311,182,1],"125б":[311,186,1],"132а":[311,193,1],"124,132б":[311,204,1],"122,135":[311,251,1],"135в":[311,269,1]};lines=["144 142 145 141а 146 141,147 148 140а 140,149 139 138,150 X11","151 X11 137 136,165 136а X12 X13 120 119,X14 118 117 116 116а 113,114","L11 X12 ВХОД","129,130,130а 128 128б,131 128а 127 126,L14 125а,М11 131а 125б 132а 124,132б 133 123 134 122,135 135в X13",];var points,MAP_HEIGHT,MAP_WIDTH,SCALE_PER_STEP=Math.pow(2,1/30),OFFSET_PER_STEP=10,ctx,canvas,img={},current_point,track,shift_x=0,shift_y=0,scale=1,man={x:0,y:0,i:0,img:{}};$(function(){var n;for(canvas=$("#canvas1")[0],$("#canvas1").attr("width",screen.availWidth).attr("height",screen.availHeight),ctx=canvas.getContext("2d"),n=1;n<3;++n)img[n]=new Image,img[n].src="floors/"+n+".svg";for(n=0;n<2;++n)man.img[n]=new Image,man.img[n].src="pic/man"+(n+1)+".png";img[img.length-1].onload=function(){init_data(dots,lines);set_current_point(points["ВХОД"]);MAP_HEIGHT=img[0].height;MAP_WIDTH=img[0].width};$("#scale_inc").on("click",function(){scale_anime(SCALE_PER_STEP)});$("#scale_dec").on("click",function(){scale_anime(1/SCALE_PER_STEP)});$(canvas).on("swipeup",function(n){n.stopPropagation();n.preventDefault();(-shift_y+canvas.height)/scale<MAP_HEIGHT&&shift_anime(0,-OFFSET_PER_STEP)});$(canvas).on("swipedown",function(n){n.stopPropagation();n.preventDefault();shift_y/scale<0&&shift_anime(0,OFFSET_PER_STEP)});$(canvas).on("swipeleft",function(n){n.stopPropagation();n.preventDefault();(-shift_x+canvas.width)/scale<MAP_WIDTH&&shift_anime(-OFFSET_PER_STEP,0)});$(document).on("swiperight","canvas",function(n){n.stopPropagation();n.preventDefault();shift_x/scale<0&&shift_anime(OFFSET_PER_STEP,0)});$(canvas).on("tap",function(n){n.stopPropagation();n.preventDefault();step_forward()});$("#goButton").on("click",find_and_show_track)});